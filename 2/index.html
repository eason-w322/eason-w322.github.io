<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CS180 Project 1 — Colorizing the Prokudin-Gorskii Photos</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
</head>
<body>
<header class="site-header">
  <h1>Colorizing the Prokudin-Gorskii Photos</h1>
  <p class="subtitle">CS180/280A • Project 1 • Eason Wei </p>
</header>

<main class="container">
  <nav class="toc">
    <a href="#overview">Overview</a>
    <a href="#approach">Approach</a>
    <a href="#pyramid">Pyramid</a>
    <a href="#results">Results</a>
    <a href="#other-examples">Other Examples</a> 
  </nav>

  <section class="content">
    <section id="overview" class="card">
      <h2>Overview</h2>
      <p>
        In this project, I reconstruct color images from Prokudin-Gorskii glass plates (top=Blue, middle=Green, bottom=Red) by aligning the G and R channels to B using a windowed search with normalized cross-correlation (NCC) and a multi-scale image-pyramid approach for large <code>.tif</code> files.
      </p>
    </section>

    <section id="approach" class="card">
      <h2>Single-Scale Alignment</h2>
      <p>
    I first divided the scanned glass plate into three equal parts corresponding to the Blue, Green, and Red channels. 
    Since the borders often contain misaligned or damaged scan edges, I cropped out 15% from all sides and worked only 
    with the central region. This ensures that the alignment focuses on meaningful image content rather than noisy borders.
  </p>
  <p>
    To align channels, I used <strong>normalized cross-correlation (NCC)</strong> within a displacement search window of 
    <code>[-15, +15]</code> pixels in both directions. For each candidate shift, NCC measures the similarity between the 
    base Blue channel and the shifted Green or Red channel. By normalizing the correlation, the metric is not dominated 
    by absolute intensity but instead emphasizes how well the two patches vary together. The displacement <code>(dy, dx)</code> 
    with the highest NCC score is chosen as the optimal alignment.
  </p>
  <p>
    I applied this method to smaller <code>.jpg</code> images such as <em>Cathedral</em>, <em>Monastery</em>, and 
    <em>Tobolsk</em>. The results demonstrate sharp alignment across channels: edges line up well and the colors combine 
    naturally into a coherent RGB image. However, I observed some color fringing around the outer edges of the images. 
    This happens because even after alignment, the very borders of the scans often differ across channels. To mitigate 
    this, I introduced a <code>crop_border</code> function that trims the final stacked RGB image slightly, removing most 
    of these residual artifacts.
  </p>
      <!-- Formula Section -->
      <div class="formula">
        <p><strong>Normalized Cross-Correlation (NCC):</strong></p>
        \[
        NCC(I, J) = \frac{\sum_{x,y} (I(x,y) - \bar{I})(J(x,y) - \bar{J})}
                      {\sqrt{\sum_{x,y} (I(x,y) - \bar{I})^2} \,
                       \sqrt{\sum_{x,y} (J(x,y) - \bar{J})^2}}
        \]
      </div>
      <div class="grid interactive-gallery">
        <figure class="tile clickable">
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/cathedral_rgb.jpg">
          <figcaption>
            <strong>Cathedral</strong>
            <div class="meta">
              G(dy, dx) = (5,2) | R(dy, dx) = (12,3)    Time: 0.185s
            </div>
          </figcaption>
        </figure>

        <figure class="tile clickable">
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/monastery_rgb.jpg">
          <figcaption>
            <strong>Monastery</strong>
            <div class="meta">
              G(dy, dx) = (-3,2) | R(dy, dx) = (3,2)    Time: 0.169s
            </div>
          </figcaption>
        </figure>

        <figure class="tile clickable">
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/tobolsk_rgb.jpg">
          <figcaption>
            <strong>Tobolsk</strong>
            <div class="meta">
              G(dy, dx) = (3,3) | R(dy, dx) = (6,3)    Time: 0.172s
            </div>
          </figcaption>
        </figure>
      </div>
    </section>

    <section id="pyramid" class="card">
      <h2>Part 2: Multi-Scale Alignment and Challenges</h2>

<h3>Pyramid Approach</h3>
<p>
  Single-scale exhaustive search is inefficient for large <code>.tif</code> images because it must try many
  displacements at full resolution. To address this, I use a <strong>coarse-to-fine image pyramid</strong>:
  the image is downsampled by a factor of two repeatedly, producing multiple levels (up to six, depending on
  image size). A helper function, <code>pick_levels</code>, selects the number of levels so the coarsest
  resolution remains above ~200 pixels.
</p>
<p>
  At the <em>coarsest</em> level I search within a wider window of <strong>±12 pixels</strong> to capture large
  displacements. The estimated offset is then doubled (to account for upsampling) and, at each finer level,
  refined within a small <strong>±3 pixel</strong> window around that guess. This coarse-to-fine procedure makes
  the search efficient while still recovering precise, pixel-level alignment at the finest scale. In practice,
  it aligns large Prokudin–Gorskii plates in seconds—both <em>fast</em> and <em>scalable</em>.
</p>

<h3>Problem Encountered: Emir</h3>
<p>
  While the pyramid improves speed and accuracy on most images, it fails on <em>emir.tif</em> when using raw
  intensity NCC. Although ZNCC is robust to <em>global</em> brightness changes, Emir exhibits strong
  <em>structural</em> differences across channels: the robe dominates Blue but not Red, while skin and walls are
  stronger in Red. These cross-channel texture/brightness inconsistencies create noisy correlation surfaces and
  drive the optimizer to a wrong match.
</p>

<section id="emir-failure" class="card">
  <h2>Emir Misalignment (Raw NCC)</h2>
  <div class="results-grid">
    <div class="result-row">
      <img
        src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/emirblurry_rgb.jpg"
        alt="Emir misaligned with raw NCC"
      >
      <div class="img-name">Emir (failed alignment with raw NCC)</div>
    </div>
  </div>
</section>

<p>
  To fix this, I replace raw intensity with the <strong>gradient magnitude</strong> at each pyramid level and run
  NCC on those edge maps. Gradients emphasize <em>edges</em> (sharp spatial changes) and suppress low-frequency
  brightness/shading; mathematically, the derivative removes additive bias and NCC’s normalization cancels
  multiplicative scale. Edges such as the turban outline, robe boundary, and doorway frame appear in the same
  locations across channels even when brightness differs, so NCC over gradients yields a sharp, reliable peak and
  the pyramid converges to the correct alignment. This gradient-based NCC is particularly effective on challenging
  cases like Emir where raw intensities mislead the search.
</p>
      <!-- Formula Section -->
      <div class="formula">
        <p><strong>Gradient Magnitude:</strong></p>
        \[
          |\nabla I| = \sqrt{\left(\frac{\partial I}{\partial x}\right)^2 + \left(\frac{\partial I}{\partial y}\right)^2}
        \]
      </div>
    </section>
    <section id="results" class="card">
  <h2>Results</h2>
  <table class="results-table">
    <thead>
      <tr>
        <th>Image</th>
        <th>G(dy, dx)</th>
        <th>R(dy, dx)</th>
        <th>Processing Time</th>
      </tr>
    </thead>
    <tbody>
      <!-- 1. Emir -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/emir_rgb.jpg" alt="Emir">
          <div class="img-name">Emir</div>
        </td>
        <td>(49, 24)</td>
        <td>(107, 40)</td>
        <td>2.449s</td>
      </tr>

      <!-- 2. Church -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/church_rgb.jpg" alt="Church">
          <div class="img-name">Church</div>
        </td>
        <td>(25, 4)</td>
        <td>(58, -4)</td>
        <td>2.675s</td>
      </tr>

      <!-- 3. Harvesters -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/harvesters_rgb.jpg" alt="Harvesters">
          <div class="img-name">Harvesters</div>
        </td>
        <td>(60, 18)</td>
        <td>(124, 13)</td>
        <td>2.585s</td>
      </tr>

      <!-- 4. Icon -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/icon_rgb.jpg" alt="Icon">
          <div class="img-name">Icon</div>
        </td>
        <td>(41, 17)</td>
        <td>(90, 23)</td>
        <td>2.696s</td>
      </tr>

      <!-- 5. Italil -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/italil_rgb.jpg" alt="Italil">
          <div class="img-name">Italil</div>
        </td>
        <td>(38, 22)</td>
        <td>(77, 36)</td>
        <td>2.633s</td>
      </tr>

      <!-- 6. Lastochikino -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/lastochikino_rgb.jpg" alt="Lastochikino">
          <div class="img-name">Lastochikino</div>
        </td>
        <td>(-3, -1)</td>
        <td>(76, -8)</td>
        <td>2.607s</td>
      </tr>

      <!-- 7. Lugano -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/lugano_rgb.jpg" alt="Lugano">
          <div class="img-name">Lugano</div>
        </td>
        <td>(41, -17)</td>
        <td>(92, -29)</td>
        <td>2.652s</td>
      </tr>

      <!-- 8. Melons -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/melons_rgb.jpg" alt="Melons">
          <div class="img-name">Melons</div>
        </td>
        <td>(80, 10)</td>
        <td>(177, 13)</td>
        <td>2.688s</td>
      </tr>

      <!-- 9. Self Portrait -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/self_portrait_rgb.jpg" alt="Self Portrait">
          <div class="img-name">Self Portrait</div>
        </td>
        <td>(78, 29)</td>
        <td>(175, 37)</td>
        <td>2.412s</td>
      </tr>

      <!-- 10. Siren -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/siren_rgb.jpg" alt="Siren">
          <div class="img-name">Siren</div>
        </td>
        <td>(49, -6)</td>
        <td>(96, -24)</td>
        <td>2.760s</td>
      </tr>

      <!-- 11. Three Generations -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/three_generations_rgb.jpg" alt="Three Generations">
          <div class="img-name">Three Generations</div>
        </td>
        <td>(53, 12)</td>
        <td>(111, 9)</td>
        <td>2.568s</td>
      </tr>
    </tbody>
  </table>
</section>
    <section id="other-examples" class="card">
  <h2>Other Examples</h2>
  <table class="results-table">
    <thead>
      <tr>
        <th>Image</th>
        <th>G(dy, dx)</th>
        <th>R(dy, dx)</th>
        <th>Processing Time</th>
      </tr>
    </thead>
    <tbody>
      <!-- Example 1 -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/example1_rgb.jpg" alt="Example 1">
          <div class="img-name">Example 1</div>
        </td>
        <td>(57, 13)</td>
        <td>(125, 24)</td>
        <td>2.045s</td>
      </tr>

      <!-- Example 2 -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/example2_rgb.jpg" alt="Example 2">
          <div class="img-name">Example 2</div>
        </td>
        <td>(63, 8)</td>
        <td>(138, 6)</td>
        <td>2.026s</td>
      </tr>

      <!-- Example 3 -->
      <tr>
        <td>
          <img src="https://raw.githubusercontent.com/eason-w322/CS180-Project-1/main/results/example3_rgb.jpg" alt="Example 3">
          <div class="img-name">Example 3</div>
        </td>
        <td>(53, 13)</td>
        <td>(122, -6)</td>
        <td>1.930s</td>
      </tr>
    </tbody>
  </table>
</section>
</main>

<div id="imageModal" class="modal">
  <span class="close">&times;</span>
  <img class="modal-content" id="modalImg">
  <div id="modalCaption"></div>
</div>

<footer class="site-footer">
  <p>© 2025 Eason Wei • CS180/280A</p>
</footer>

<script src="compare.js"></script>
</body>
</html>
